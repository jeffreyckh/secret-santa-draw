<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secret Santa Draw</title>
<style>
body{font-family:Inter,sans-serif;margin:20px;background:#f7fafc;color:#111}
h1{margin-bottom:10px}
select,button{padding:8px;margin:4px;border-radius:6px;border:1px solid #d1d5db;font-size:16px}
button{background:#0369a1;color:white;cursor:pointer}
#selfResult{margin-top:12px;font-weight:bold;color:#0369a1;font-size:18px}
</style>
</head>
<body>
<h1>Secret Santa Draw</h1>
<p>Select your name to draw your recipient (private).</p>

<select id="selfSelect"><option value="">-- Select your name --</option></select>
<button onclick="selfDrawRecipient()">Draw Recipient</button>
<p id="selfResult"></p>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyuhKqidBzNJCAHOftS_gAAHMaiAlQLOB0Wm8pT31m_iAFf1A0Lrn6VzOi21LjAV0Ab/exec";

let participants = [], drawnFlags=[], giverUsed=[];

async function loadParticipants(){
  const res = await fetch(API_URL);
  participants = await res.json();
  drawnFlags = participants.map(p=>p.recipient!=='');
  giverUsed = participants.map(p=>p.recipient!=='');
  const sel = document.getElementById("selfSelect");
  participants.forEach((p,i)=>{
    const opt=document.createElement("option");
    opt.value=i; opt.textContent=p.name + " (" + p.loc + ")";
    sel.appendChild(opt);
  });
}

async function selfDrawRecipient(){
  const sel = document.getElementById("selfSelect");
  const giverIndex=parseInt(sel.value,10);
  if(isNaN(giverIndex)){ alert("Select your name"); return; }
  if(giverUsed[giverIndex]){document.getElementById("selfResult").textContent="You already drew!"; return;}
  const giver = participants[giverIndex];
  const candidates = participants.filter((p,i)=>i!==giverIndex&&!drawnFlags[i]&&p.loc!==giver.loc);
  if(candidates.length===0){document.getElementById("selfResult").textContent="No valid recipient";return;}
  const choice = candidates[Math.floor(Math.random()*candidates.length)];
  await fetch(API_URL,{method:'POST',body:JSON.stringify({giverIndex,recipientName:choice.name})});
  document.getElementById("selfResult").textContent=`You got: ${choice.name}`;
  drawnFlags[participants.indexOf(choice)]=true;
  giverUsed[giverIndex]=true;
}

loadParticipants();
</script>
</body>
</html>
